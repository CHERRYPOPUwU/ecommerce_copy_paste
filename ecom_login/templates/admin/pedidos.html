{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">ðŸ“¦ Pedidos realizados</h2>

  <!-- Filtros (opcional pero Ãºtil) -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h5 class="mb-0">Total de pedidos: <span class="badge bg-primary">{{ pedidos|length }}</span></h5>
        </div>
        <div class="col-md-6 text-end">
          <small class="text-muted">
            <i class="bi bi-info-circle"></i> Los pedidos se ordenan del mÃ¡s reciente al mÃ¡s antiguo
          </small>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-bordered text-center align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th style="width: 80px;">ID</th>
              <th>Cliente</th>
              <th style="width: 150px;">Fecha</th>
              <th style="width: 120px;">Total</th>
              <th style="width: 140px;">Estado</th>
              <th style="width: 250px;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for pedido in pedidos %}
            <tr>
              <td class="fw-bold">#{{ pedido.id }}</td>
              <td>
                <div>
                  <strong>{{ pedido.usuario.nombre }}</strong><br>
                  <small class="text-muted">{{ pedido.usuario.correo }}</small>
                </div>
              </td>
              <td>
                <small>{{ pedido.fecha.strftime('%d/%m/%Y') }}</small><br>
                <small class="text-muted">{{ pedido.fecha.strftime('%H:%M') }}</small>
              </td>
              <td>
                <span class="h6 mb-0 text-success">${{ "%.2f"|format(pedido.total) }}</span>
              </td>
              <td>
                <span class="badge 
                  {% if pedido.estado == 'Pendiente de Pago' %}bg-secondary
                  {% elif pedido.estado == 'Pendiente' or pedido.estado == 'Confirmado' %}bg-warning text-dark
                  {% elif pedido.estado == 'Enviado' %}bg-info text-dark
                  {% elif pedido.estado == 'Entregado' %}bg-success
                  {% elif pedido.estado == 'Cancelado' %}bg-danger
                  {% else %}bg-secondary{% endif %}">
                  {{ pedido.estado }}
                </span>
              </td>
              <td>
                <div class="btn-group" role="group">
                  <!-- Ver detalles -->
                  <a href="{{ url_for('admin_detalle_pedido', pedido_id=pedido.id) }}" 
                     class="btn btn-sm btn-primary"
                     title="Ver detalles del pedido">
                    <i class="bi bi-eye"></i> Ver
                  </a>
                  
                  <!-- Cancelar pedido (solo si no estÃ¡ entregado o cancelado) -->
                  {% if pedido.estado not in ['Entregado', 'Cancelado'] %}
                  <form method="POST" 
                        action="{{ url_for('cancelar_pedido_admin', pedido_id=pedido.id) }}" 
                        class="d-inline"
                        onsubmit="return confirm('Â¿EstÃ¡s seguro de cancelar el pedido #{{ pedido.id }}?\n\nSi el pedido estÃ¡ confirmado, se devolverÃ¡ el stock automÃ¡ticamente.');">
                    <button type="submit" 
                            class="btn btn-sm btn-danger"
                            title="Cancelar pedido">
                      <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                  </form>
                  {% else %}
                  <button class="btn btn-sm btn-secondary" 
                          disabled
                          title="No se puede cancelar un pedido {{ pedido.estado|lower }}">
                    <i class="bi bi-x-circle"></i> Cancelar
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" class="text-center py-5">
                <div class="text-muted">
                  <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                  <p class="mt-3 mb-0">No hay pedidos registrados.</p>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Leyenda de estados -->
  <div class="card shadow-sm mt-4">
    <div class="card-body">
      <h6 class="fw-bold mb-3">ðŸ“‹ Leyenda de Estados:</h6>
      <div class="row g-2">
        <div class="col-md-4">
          <span class="badge bg-secondary me-2">Pendiente de Pago</span>
          <small>El usuario no ha completado el pago</small>
        </div>
        <div class="col-md-4">
          <span class="badge bg-warning text-dark me-2">Confirmado</span>
          <small>Pago confirmado, listo para enviar</small>
        </div>
        <div class="col-md-4">
          <span class="badge bg-info text-dark me-2">Enviado</span>
          <small>Pedido en camino al cliente</small>
        </div>
        <div class="col-md-4">
          <span class="badge bg-success me-2">Entregado</span>
          <small>Pedido completado exitosamente</small>
        </div>
        <div class="col-md-4">
          <span class="badge bg-danger me-2">Cancelado</span>
          <small>Pedido cancelado (stock devuelto)</small>
        </div>
      </div>
    </div>
  </div>

  <!-- EstadÃ­sticas rÃ¡pidas (opcional) -->
  <div class="row mt-4 g-3">
    <div class="col-md-3">
      <div class="card text-center" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border: none;">
        <div class="card-body">
          <h3 class="mb-0">
            {{ pedidos|selectattr('estado', 'equalto', 'Pendiente de Pago')|list|length }}
          </h3>
          <small class="text-muted">Pendientes de Pago</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center" style="background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%); border: none;">
        <div class="card-body">
          <h3 class="mb-0">
            {{ pedidos|selectattr('estado', 'equalto', 'Confirmado')|list|length }}
          </h3>
          <small class="text-muted">Por Enviar</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center" style="background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%); border: none;">
        <div class="card-body">
          <h3 class="mb-0">
            {{ pedidos|selectattr('estado', 'equalto', 'Entregado')|list|length }}
          </h3>
          <small class="text-muted">Completados</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center" style="background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%); border: none;">
        <div class="card-body">
          <h3 class="mb-0">
            {{ pedidos|selectattr('estado', 'equalto', 'Cancelado')|list|length }}
          </h3>
          <small class="text-muted">Cancelados</small>
        </div>
      </div>
    </div>
  </div>

  <!-- BotÃ³n para volver -->
  <div class="text-center mt-4">
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Volver al Panel
    </a>
  </div>
</div>

<style>
.table tbody tr {
  transition: all 0.2s ease;
}

.table tbody tr:hover {
  background-color: rgba(255, 107, 157, 0.05);
  transform: scale(1.01);
}

.btn-group {
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  border-radius: 8px;
  overflow: hidden;
}

@media (max-width: 768px) {
  .btn-group {
    display: flex;
    flex-direction: column;
  }
  
  .btn-group .btn {
    border-radius: 4px !important;
    margin-bottom: 4px;
  }
}
</style>

<script>
// ConfirmaciÃ³n mejorada para cancelaciÃ³n
document.querySelectorAll('form[action*="cancelar"]').forEach(form => {
  form.addEventListener('submit', function(e) {
    const pedidoId = this.action.split('/').pop().split('?')[0];
    const confirmMsg = `âš ï¸ CANCELAR PEDIDO #${pedidoId}\n\n` +
                      `Esta acciÃ³n:\n` +
                      `â€¢ CancelarÃ¡ el pedido permanentemente\n` +
                      `â€¢ DevolverÃ¡ el stock si ya estaba confirmado\n` +
                      `â€¢ MarcarÃ¡ el pago como cancelado\n\n` +
                      `Â¿EstÃ¡s seguro de continuar?`;
    
    if (!confirm(confirmMsg)) {
      e.preventDefault();
    }
  });
});

// Highlight de fila al pasar el mouse
document.querySelectorAll('tbody tr').forEach(row => {
  row.addEventListener('mouseenter', function() {
    this.style.backgroundColor = 'rgba(255, 107, 157, 0.08)';
  });
  
  row.addEventListener('mouseleave', function() {
    this.style.backgroundColor = '';
  });
});
</script>
{% endblock %}