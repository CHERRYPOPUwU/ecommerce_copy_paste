{% extends 'base.html' %}
{% block content %}
<div class="container mt-5 mb-5">
  <div class="text-center mb-5">
    <h1 class="display-5 fw-bold mb-2" style="background: linear-gradient(135deg, #FF6B9D 0%, #C084FC 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
      üõí Mi Carrito de Compras
    </h1>
    <p class="text-muted">Revisa tus productos antes de finalizar</p>
  </div>

  {% if items %}
  <div class="row g-4">
    <!-- Lista de productos -->
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <h5 class="fw-bold mb-4">üì¶ Productos ({{ items|length }})</h5>
          
          {% for item in items %}
          <div class="row align-items-center mb-4 pb-4 border-bottom">
            <!-- Imagen del producto -->
            <div class="col-md-2 col-3">
              <img src="{{ item.producto.imagen or url_for('static', filename='img/default.png') }}" 
                   class="img-fluid rounded" 
                   alt="{{ item.producto.nombre }}"
                   style="height: 80px; width: 80px; object-fit: cover;">
            </div>

            <!-- Informaci√≥n del producto -->
            <div class="col-md-3 col-5">
              <h6 class="fw-bold mb-1">{{ item.producto.nombre }}</h6>
              <p class="text-muted small mb-0">{{ item.producto.descripcion[:50] }}...</p>
              <small class="text-success">
                <i class="bi bi-check-circle-fill"></i> En stock
              </small>
            </div>

            <!-- Selector de cantidad -->
            <div class="col-md-3 col-12 mt-3 mt-md-0">
              <form method="POST" action="{{ url_for('actualizar_cantidad_carrito', item_id=item.id) }}" class="cantidad-form">
                <label class="form-label small fw-bold mb-1">Cantidad:</label>
                <div class="input-group input-group-sm" style="max-width: 150px;">
                  <select name="cantidad" class="form-select" onchange="this.form.submit()">
                    {% for i in range(1, [item.producto.stock + 1, 21]|min) %}
                    <option value="{{ i }}" {% if i == item.cantidad %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                    {% if item.producto.stock > 20 %}
                    <option value="{{ item.producto.stock }}" {% if item.cantidad == item.producto.stock %}selected{% endif %}>
                      {{ item.producto.stock }} (M√°x)
                    </option>
                    {% endif %}
                  </select>
                  <button type="submit" class="btn btn-outline-primary" style="display: none;">
                    <i class="bi bi-arrow-repeat"></i>
                  </button>
                </div>
              </form>
            </div>

            <!-- Precio unitario -->
            <div class="col-md-2 col-6 mt-3 mt-md-0">
              <div class="text-center">
                <span class="text-muted small d-block">Precio unit.</span>
                <span class="fw-bold">${{ "%.2f"|format(item.producto.precio) }}</span>
              </div>
            </div>

            <!-- Subtotal y acciones -->
            <div class="col-md-2 col-6 mt-3 mt-md-0">
              <div class="text-center">
                <span class="text-muted small d-block">Subtotal</span>
                <span class="fw-bold h5 mb-2 d-block" style="color: #FF6B9D;">
                  ${{ "%.2f"|format(item.producto.precio * item.cantidad) }}
                </span>
                <a href="{{ url_for('eliminar_item', item_id=item.id) }}" 
                   class="btn btn-sm btn-outline-danger"
                   onclick="return confirm('¬øEliminar este producto del carrito?');">
                  üóëÔ∏è Eliminar
                </a>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Resumen del pedido -->
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
        <div class="card-body p-4">
          <h5 class="fw-bold mb-4">üí∞ Resumen del Pedido</h5>
          
          <div class="d-flex justify-content-between mb-3">
            <span class="text-muted">Productos ({{ items|length }})</span>
            <span class="fw-bold">${{ "%.2f"|format(total) }}</span>
          </div>

          <div class="d-flex justify-content-between mb-3">
            <span class="text-muted">Env√≠o</span>
            <span class="text-success fw-bold">GRATIS üéâ</span>
          </div>

          <hr class="my-3">

          <div class="d-flex justify-content-between mb-4">
            <span class="h5 fw-bold">Total</span>
            <span class="h4 fw-bold" style="background: linear-gradient(135deg, #FF6B9D 0%, #C084FC 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
              ${{ "%.2f"|format(total) }}
            </span>
          </div>

          <!-- Botones de acci√≥n -->
          <form method="POST" action="{{ url_for('finalizar_compra') }}" class="mb-3">
            <button type="submit" class="btn btn-success w-100 btn-lg mb-2">
              üí≥ Proceder al Pago
            </button>
          </form>

          <a href="{{ url_for('home') }}" class="btn btn-outline-secondary w-100 mb-2">
            ‚¨ÖÔ∏è Seguir Comprando
          </a>

          <a href="{{ url_for('vaciar_carrito') }}" 
             class="btn btn-outline-danger w-100"
             onclick="return confirm('¬øEst√°s seguro de vaciar todo el carrito?');">
            üóëÔ∏è Vaciar Carrito
          </a>

          <!-- Informaci√≥n adicional -->
          <div class="mt-4 p-3 rounded" style="background: linear-gradient(135deg, #FFF1F2 0%, #FFE4E6 100%);">
            <div class="text-center">
              <div class="mb-2" style="font-size: 2rem;">üîí</div>
              <p class="small mb-0 fw-bold">Compra 100% Segura</p>
              <p class="small text-muted mb-0">Tus datos est√°n protegidos</p>
            </div>
          </div>

          <!-- Beneficios -->
          <div class="mt-3">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-truck text-success me-2"></i>
              <small>Env√≠o gratis en todos los pedidos</small>
            </div>
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-shield-check text-success me-2"></i>
              <small>Garant√≠a de satisfacci√≥n</small>
            </div>
            <div class="d-flex align-items-center">
              <i class="bi bi-arrow-counterclockwise text-success me-2"></i>
              <small>Devoluciones f√°ciles</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% else %}
  <!-- Carrito vac√≠o -->
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow-sm border-0 text-center p-5">
        <div class="mb-4" style="font-size: 6rem;">üõí</div>
        <h3 class="fw-bold mb-3">Tu carrito est√° vac√≠o</h3>
        <p class="text-muted mb-4">¬°Agrega algunos coleccionables incre√≠bles!</p>
        <a href="{{ url_for('home') }}" class="btn btn-primary btn-lg">
          üõçÔ∏è Ir a Comprar
        </a>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<style>
@media (max-width: 768px) {
  .sticky-top {
    position: relative !important;
  }
}

.card {
  border-radius: 20px;
}

.border-bottom:last-child {
  border-bottom: none !important;
  padding-bottom: 0 !important;
  margin-bottom: 0 !important;
}

.cantidad-form select {
  cursor: pointer;
  transition: all 0.3s ease;
}

.cantidad-form select:hover {
  border-color: #FF6B9D;
  box-shadow: 0 0 0 0.2rem rgba(255, 107, 157, 0.25);
}

.input-group-sm .form-select {
  font-size: 0.9rem;
  padding: 0.4rem 0.8rem;
}

/* Animaci√≥n al cambiar cantidad */
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.cantidad-form select:focus {
  animation: pulse 0.3s ease;
}
</style>

<script>
// Confirmaci√≥n antes de vaciar carrito
for (const link of document.querySelectorAll('a[href*="vaciar_carrito"]')) {
  link.addEventListener('click', function(e) {
    if (!confirm('¬øEst√°s seguro de que quieres vaciar todo el carrito?')) {
      e.preventDefault();
    }
  });
}

// Animaci√≥n al actualizar cantidad
for (const select of document.querySelectorAll('.cantidad-form select')) {
  select.addEventListener('change', function() {
    this.closest('.input-group').style.animation = 'pulse 0.3s ease';
  });
}

</script>
{% endblock %}